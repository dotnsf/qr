<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>[HTML5] QRCode Reader</title>
  <style>
    /* 全体のレイアウト調整 */
    #contents { display:flex; width:650px;}
    #camera, #picture1, #picture2, #result { justify-content:center; margin:5px;}

    /* リーダー部分 */
    /*#picture { display:none; }*/
    #result { border: 1px solid gray; width:300px; height:200px; padding:10px;}
    small { color:gray; }
  </style>
</head>
<body>

<h1>QRCode Reader</h1>

<section id="contents">
  <!-- 処理用 -->
  <canvas id="picture1" width="200" height="200"></canvas>
  <canvas id="picture2" width="200" height="200"></canvas>

  <!-- 読み取り結果 -->
  <div id="result">
    <small>※ここに読み取り結果が表示されます※</small>
  </div>
</section>

<script src="./jsQR.min.js"></script>
<script>
const canvas1 = $("#picture1");    // === document.querySelector("#picture");
const ctx1 = canvas1.getContext("2d");
const canvas2 = $("#picture2");    // === document.querySelector("#picture");
const ctx2 = canvas2.getContext("2d");

window.onload = () => {
  // QRコードのチェック開始
  checkPictures();
};

/**
 * QRコードの読み取り
 */
function checkPictures(){
  var img1 = new Image;
  img1.src = './qrcode_sample_colormanhole.png';
  img1.onload = () => {
    // カメラの映像をCanvasに複写
    ctx1.drawImage(img1, 0, 0, canvas1.width, canvas1.height);

    // QRコードの読み取り
    const imageData1 = ctx1.getImageData(0, 0, canvas1.width, canvas1.height);
    const code1 = jsQR(imageData1.data, canvas1.width, canvas1.height);

    console.log( 'code1', code1 );
  };

  var img2 = new Image;
  img2.src = './qrcode_sample_colormanhole.png';
  img2.onload = () => {
    // カメラの映像をCanvasに複写
    ctx2.drawImage(img2, 0, 0, canvas2.width, canvas2.height);

    // QRコードの読み取り
    const imageData2 = ctx2.getImageData(0, 0, canvas2.width, canvas2.height);
    const code2 = jsQR(imageData2.data, canvas2.width, canvas2.height);

    console.log( 'code2', code2 );
  };
}


/**
 * 発見されたQRコードに線を引く
 *
 * @param {Object} ctx
 * @param {Object} pos
 * @param {Object} options
 * @return {void}
 */
function drawLine(ctx, pos, options={color:"blue", size:5}){
  // 線のスタイル設定
  ctx.strokeStyle = options.color;
  ctx.lineWidth   = options.size;

  // 線を描く
  ctx.beginPath();
  ctx.moveTo(pos.topLeftCorner.x, pos.topLeftCorner.y);         // 左上からスタート
  ctx.lineTo(pos.topRightCorner.x, pos.topRightCorner.y);       // 右上
  ctx.lineTo(pos.bottomRightCorner.x, pos.bottomRightCorner.y); // 右下
  ctx.lineTo(pos.bottomLeftCorner.x, pos.bottomLeftCorner.y);   // 左下
  ctx.lineTo(pos.topLeftCorner.x, pos.topLeftCorner.y);         // 左上に戻る
  ctx.stroke();
}

/**
 * QRコードの読み取り結果を表示する
 *
 * @param {String} id
 * @param {String} data
 * @return {void}
 */
function setQRResult(id, data){
  $(id).innerHTML = escapeHTML(data);
}

/**
 * jQuery style wrapper
 *
 * @param {string} selector
 * @return {Object}
 */
 function $(selector){
  return( document.querySelector(selector) );
}

/**
 * HTML表示用に文字列をエスケープする
 *
 * @param {string} str
 * @return {string}
 */
function escapeHTML(str){
  let result = "";
  result = str.replace("&", "&amp;");
  result = str.replace("'", "&#x27;");
  result = str.replace("`", "&#x60;");
  result = str.replace('"', "&quot;");
  result = str.replace("<", "&lt;");
  result = str.replace(">", "&gt;");
  result = str.replace(/\n/, "<br>");

  return(result);
}
</script>

</body>
</html>
